<!DOCTYPE html>

<html lang="en">
	<head>
		<title>BookShop - Cart</title>
		<meta charset="UTF-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE-edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<link rel="icon" type="image/png" href="../media/favicon.avif"/>
		<link rel="stylesheet" type="text/css" href="styles.css"/>

		<style>
		img {
			height: 8vh;
		}

		#cartTable {
			/* hide table before json file is loaded */
			display: none;
		}

		#cartTable colgroup {
			width: 16vw;
		}
		</style>
	</head>

	<body>
		<header id="top">
			<nav>
				<a href="index.html">HOME</a>
				<a href="about.html">ABOUT</a>
				<a href="cart.html">CART</a>
			</nav>
		</header>

		<nav id="jump">
			<a href="#top">Jump to Top</a>
		</nav>

		<main>
			<article>
				<h1 class="center">Shopping Cart</h1>

				<noscript>
					<p class="center">This webpage requires JavaScript to function.</p>
				</noscript>

				<section>
					<h2>Cart Items</h2>

					<form id="cartForm" method="post" onsubmit="loadCart(event);">
						<!-- user needs to select json file due to restrictions browsers place on `file:///` -->
						<p>
							<input
								type="file"
								name="json"
								accept=".json"
								title="Select a JSON file to load cart items from"
								required
							>
						</p>

						<p>
							<input type="submit" name="submit" value="Load Cart Items">
						</p>
					</form>

					<button onclick="clearCart();">Clear Cart</button>

					<table id="cartTable">
						<caption>Books in Shopping Cart</caption>

						<colgroup>
							<col span=4></col>
						</colgroup>

						<thead>
							<th>Book Cover</th>
							<th>Book Name</th>
							<th>Price</th>
							<th>Quantity</th>
						</thead>

						<tbody>
							<!-- cart items go below here -->
						</tbody>
					</table>
				</section>

				<hr>

				<section>
					<h2>Confirm Your Order</h2>

					<table id="totalTable">
						<caption>Total to be Paid</caption>

						<colgroup>
							<col span=2></col>
						</colgroup>

						<thead>
							<th>Subtotal</th>
							<th>Price</th>
						</thead>

						<tbody>
							<tr>
								<td>Price of Items</td>
								<td id="total">$0.00</td>
							</tr>

							<tr>
								<td>9% Goods and Services Tax (GST)</td>
								<td id="tax">$0.00</td>
							</tr>

							<tr>
								<td>Total Payable</td>
								<td id="payable">$0.00</td>
							</tr>
						</tbody>
					</table>
				</section>

				<div style="text-align: right;"><a href="pay.html"><button id="proceed"><p>Proceed To Payment</p></button></a></div>
			</article>
		</main>

		<script>
		// get cart table
		let cartTable = document.getElementById("cartTable");
		let cartBody = cartTable.getElementsByTagName("tbody")[0];
		let cartRows = cartBody.children;

		function loadCart(event) { // load json cart items onto page
			event.preventDefault(); // prevent form submit from refreshing page

			// get json file
			const cartForm = document.getElementById("cartForm");
			const fileInput = cartForm.elements["json"];
			const file = fileInput.files[0];

			if(!file) { // show error and stop if no file
				alert("ERROR: No file selected");
				return;
			}

			const jsonReader = new FileReader();

			jsonReader.onload = (jsonEvent) => { // triggers from `jsonReader.readAsText(file);`
				let jsonData = [];

				try {
					jsonData = JSON.parse(jsonEvent.target.result);
				} catch(error) {
					alert("ERROR: File is either empty or not JSON.\n" + error.name + ".\n" + error.message);
					return;
				}

				if(!Array.isArray(jsonData)) {
					alert("ERROR: JSON data is not an array");
					return;
				}

				for(let book of jsonData) {
					// retrieve book title from json
					let bookTitle = book["title"];

					let inCart = false;
					
					for(let row of cartBody.children) { // check if book is already in table
						if(bookTitle == row.getElementsByTagName("td")[1].innerText) {
							inCart = true;
							break;
						}
					}

					if(inCart) { break; }

					// retrieve other book data
					let bookCover = book["img"];
					let bookPrice = book["price"];
					let bookQty = book["qty"];

					// add table rows of book title, cover, price, and quantity in cart table
					cartBody.innerHTML += `
						<tr>
							<td><img src="${bookCover}" alt="Book Cover"></td>
							<td>${bookTitle}</td>
							<td>${bookPrice}</td>
							<td><input type="number" oninput="updateTotals();" inputmode="numeric" value="${bookQty}" min="0" max="9"></td>
						</tr>
					`
				}

				// show cart table
				cartTable.style.display = "block";

				// update subtotal values
				updateTotals();
			}

			jsonReader.readAsText(file); // triggers the above jsonReader.onload code
		}

		function clearCart() {
			// reset cartBody
			cartBody.innerHTML = `
				<tbody>
					<!-- cart items go below here -->
				</tbody>
			`

			// hide cart table
			cartTable.style.display = "none";
		}

		function updateTotals() {
			// get prices of all books in cart and sum them
			let priceSum = 0.00;

			for(let row of cartRows) {
				let cols = row.getElementsByTagName("td");

				let qtyInput = cols[3].getElementsByTagName("input")[0];
				let qty = qtyInput.value;

				if(qty < 1) {
					row.remove();
					continue;
				}

				let priceStr = cols[2].innerText;
				let price = parseFloat(priceStr.substring(1));

				priceSum += (price * qty);
			}

			if(cartRows.length < 1) {
				cartTable.style.display = "none";
				return;
			}

			// calculate 9% gst tax and truncate to 2 decimal places
			let tax = Math.trunc(priceSum * 0.09 * 100) / 100;

			// sum price and tax for payable
			let payable = (priceSum + tax);

			// set subtotals to new values
			document.getElementById("total").innerText = `$${priceSum.toFixed(2)}`;
			document.getElementById("tax").innerText = `$${tax.toFixed(2)}`;
			document.getElementById("payable").innerText = `$${payable.toFixed(2)}`;
		}

		function proceed() {
			// make sure payable is above 0 before proceeding to payment
		}
		</script>
	</body>
</html>
